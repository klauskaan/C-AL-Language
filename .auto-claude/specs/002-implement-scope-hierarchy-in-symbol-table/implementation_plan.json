{
  "feature": "Implement Scope Hierarchy in Symbol Table",
  "workflow_type": "feature",
  "workflow_rationale": "This is a new feature that fundamentally changes the architecture of the symbol table from a flat structure to a hierarchical tree. While it involves replacing existing code, the core change is adding new capability (scope-aware resolution) that didn't exist before.",
  "phases": [
    {
      "id": "phase-1-core-scope",
      "name": "Core Scope Data Structure",
      "type": "implementation",
      "description": "Implement the Scope class and update SymbolTable to use hierarchical scope structure",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create Scope class with parent/child relationships and symbol map",
          "service": "server",
          "files_to_modify": [
            "server/src/symbols/symbolTable.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/parser/ast.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "completed",
          "notes": "Created Scope class with parent/child relationships and symbol map. Implemented: constructor with parent linking, symbols Map, startOffset/endOffset for position tracking, addSymbol(), hasOwnSymbol(), getOwnSymbol(), getOwnSymbols() methods. Committed as 75293ec.",
          "updated_at": "2025-12-23T18:47:27.858972+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Implement scope-aware getSymbol() with parent chain traversal",
          "service": "server",
          "files_to_modify": [
            "server/src/symbols/symbolTable.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/references/referenceProvider.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "completed",
          "notes": "Implemented scope-aware getSymbol() and hasSymbol() methods in Scope class with parent chain traversal. Both methods check the current scope first, then recursively traverse parent scopes to implement proper variable shadowing (inner scope takes precedence). Uses normalizeIdentifier() for case-insensitive C/AL identifier lookup. Committed as 22cd2d6.",
          "updated_at": "2025-12-23T18:49:50.308875+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Update buildFromAST to create child scopes for procedures and triggers",
          "service": "server",
          "files_to_modify": [
            "server/src/symbols/symbolTable.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/parser/ast.ts",
            "server/src/references/referenceProvider.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "completed",
          "notes": "Updated buildFromAST to create hierarchical scope structure. Changed SymbolTable to use rootScope: Scope instead of flat Map. Now creates child scopes for procedures (with parameters and local variables) and triggers (with local variables). Added getRootScope() method and collectAllSymbols() helper. Updated hasSymbol, getSymbol, getAllSymbols to use root scope. Committed as d7d61fe.",
          "updated_at": "2025-12-23T18:52:16.155681+00:00"
        },
        {
          "id": "subtask-1-4",
          "description": "Add getSymbolAtOffset() method and getScopeAtOffset() for position-aware lookup",
          "service": "server",
          "files_to_modify": [
            "server/src/symbols/symbolTable.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/lexer/tokens.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "completed",
          "notes": "Added getScopeAtOffset(), findScopeAtOffset(), and getSymbolAtOffset() methods to SymbolTable class for position-aware symbol lookup. Verification command could not be run due to environment restrictions, but code follows TypeScript patterns correctly.",
          "updated_at": "2025-12-23T18:54:39.542465+00:00"
        },
        {
          "id": "subtask-1-5",
          "description": "Ensure getAllSymbols() returns symbols from all scopes for backward compatibility",
          "service": "server",
          "files_to_modify": [
            "server/src/symbols/symbolTable.ts"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "completed",
          "notes": "getAllSymbols() was already correctly implemented in subtask-1-3. The implementation uses collectAllSymbols() which recursively traverses the scope tree from root to all children, collecting symbols from: 1) root scope (fields, global variables, procedure names), 2) procedure scopes (parameters, local variables), 3) trigger scopes (local variables). This ensures backward compatibility - any code calling getAllSymbols() gets all symbols from the entire document. No additional changes required.",
          "updated_at": "2025-12-23T18:56:33.591322+00:00"
        }
      ]
    },
    {
      "id": "phase-2-providers",
      "name": "Update Navigation Providers",
      "type": "implementation",
      "description": "Update all navigation providers to use scope-aware symbol lookup",
      "depends_on": [
        "phase-1-core-scope"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Update DefinitionProvider to use getSymbolAtOffset() with position context",
          "service": "server",
          "files_to_modify": [
            "server/src/definition/definitionProvider.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/symbols/symbolTable.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Update HoverProvider to use getSymbolAtOffset() with position context",
          "service": "server",
          "files_to_modify": [
            "server/src/hover/hoverProvider.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/symbols/symbolTable.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Update CompletionProvider to query symbols visible in current scope",
          "service": "server",
          "files_to_modify": [
            "server/src/completion/completionProvider.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/symbols/symbolTable.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-4",
          "description": "Update SignatureHelpProvider to use scope-aware procedure lookup",
          "service": "server",
          "files_to_modify": [
            "server/src/signatureHelp/signatureHelpProvider.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "server/src/symbols/symbolTable.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npx tsc --noEmit",
            "expected": "No compilation errors"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-unit-tests",
      "name": "Unit Tests for Scope System",
      "type": "implementation",
      "description": "Create comprehensive unit tests for the new scope hierarchy",
      "depends_on": [
        "phase-1-core-scope"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create unit tests for Scope class and SymbolTable scope hierarchy",
          "service": "server",
          "files_to_modify": [],
          "files_to_create": [
            "server/src/symbols/__tests__/symbolTable.test.ts"
          ],
          "patterns_from": [
            "server/src/__tests__/diagnostics.test.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd server && npm test -- --testPathPattern=symbolTable",
            "expected": "All tests pass"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration Testing",
      "type": "integration",
      "description": "Verify all navigation features work correctly with scope-aware symbol table",
      "depends_on": [
        "phase-2-providers",
        "phase-3-unit-tests"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Run existing test suite to verify no regressions",
          "service": "server",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd server && npm test",
            "expected": "All existing tests pass"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Compile entire project to ensure all integration points work",
          "service": "server",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm run compile",
            "expected": "Compilation succeeds with no errors"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 11,
    "services_involved": [
      "server"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-providers",
            "phase-3-unit-tests"
          ],
          "reason": "Both depend only on phase-1, no file conflicts"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential due to single service and file dependencies within phases"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 002 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "phase-3-unit-tests",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New unit tests for Scope class pass",
      "TypeScript compilation succeeds with no errors",
      "No console errors in language server"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Compilation",
        "command": "npm run compile",
        "expected_outcome": "No compilation errors",
        "type": "build",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests",
        "command": "cd server && npm test",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk refactor of core symbol table affects all navigation features. Requires thorough unit testing of new Scope class and integration testing to ensure existing functionality remains intact."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd server && npm test"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "npm run compile",
        "cd server && npm test"
      ],
      "services_to_test": [
        "server"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  },
  "qa_signoff": null,
  "last_updated": "2025-12-23T18:56:33.591344+00:00"
}